I"£&<!--more-->

<p>In the <a href="/blog/qwiklabs/Build-and-Deploy-a-Docker-Image-to-a-Kubernetes-Cluster">last lab</a>, you built a docker image and created a Kubernetes cluster for a containerized application, called <code class="highlighter-rouge">echo-app</code>. Considering your developer team delivers a new version of the application to you, so you need to update the running application on the cluster to the new version. You may also need to scale the cluster size to optimize the usage and performance. You will do this in the lab <strong>GSP305</strong> <em>â€œ<a href="https://www.qwiklabs.com/focuses/1739?parent=catalog">Scale Out and Update a Containerized Application on a Kubernetes Cluster</a>â€œ</em>. This lab will perform provisioning of the application <code class="highlighter-rouge">echo-app:v1</code> as the same in the previous lab. You will continue practising with the <code class="highlighter-rouge">echo-app</code> application in the <code class="highlighter-rouge">echo-web</code> deployment, and update its version from v1 to v2.</p>

<p><br /></p>

<h2 id="brief-introduction-of-challenge-scenario">Brief Introduction of Challenge Scenario</h2>

<p>When you open the page of this lab in Qwiklabs, you can find the task requirements by click the green activity tracker (on the top right of the page) to expand the score box.</p>

<p><img src="/images/posts/qwiklabs/score_box_of_qwiklabs_GSP305.png" alt="Screenshot of Green Score box of Qwiklabs Hands-on-lab GSP305" /></p>

<p>The screenshot above shows that there are 4 steps required for completing this lab. Combining with the instruction details, they are translated to the following mission statements.</p>

<ol>
  <li>Update a docker application and push a new version of image tagged <code class="highlighter-rouge">echo-app:v2</code> to a container repository (gcr.io).</li>
  <li>Upload the deployment running on the Kubernetes cluster to <code class="highlighter-rouge">echo-app:v2</code>.</li>
  <li>Scale out the application so that the Kubernetes cluster deployment is running 2 replicas.</li>
  <li>The application must respond to web requests with V2.0.0.</li>
</ol>

<p><br /></p>

<h2 id="build-a-docker-image-of-sample-application-with-a-v2-tag">Build a Docker Image of Sample Application with a <code class="highlighter-rouge">v2</code> tag</h2>

<p>Just similar to the <a href="/blog/qwiklabs/Build-and-Deploy-a-Docker-Image-to-a-Kubernetes-Cluster">steps in the last lab</a>, you can start with the pre-uploaded archive that contains the sample application and the docker configuration in the Cloud Storage bucket. Use a <code class="highlighter-rouge">gsutil cp</code> command to copy the archive from the Cloud Storage to the Cloud Shell environment. Next, use a <code class="highlighter-rouge">tar -xvzf</code> command to unzip the files. You may use a code editor to compare the change between the v1 and v2 codes. After that, use <code class="highlighter-rouge">docker</code> commands to build, tag and push the new container image to Google Container Registry (gcr.io). If you do not remember how to build a docker image on GCP, I recommend you revise the lab <em>â€œ<a href="https://www.qwiklabs.com/focuses/1029?parent=catalog">Introduction to Docker</a>â€œ</em> before you start.</p>

<p>Edit the line in the <code class="highlighter-rouge">/manifests/echoweb-deployment.yaml</code> file defining which image to use:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">echoweb</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">echo</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">echo</span>
        <span class="na">tier</span><span class="pi">:</span> <span class="s">web</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">echo-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/PROJECT_ID/echo-app:v2</span> <span class="c1"># Update this to v2.</span>
                                             <span class="c1"># Replace PROJECT_ID</span>
                                             <span class="c1"># with your project</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8000</span>
</code></pre></div></div>
<p><strong>Save</strong> the file.</p>

<p>Build a new docker image of the sample application with a tag called <code class="highlighter-rouge">v2</code>, and push the image to Google Container Registry,</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> echo-app:v2 <span class="nb">.</span>
<span class="nb">export </span><span class="nv">PROJECT_ID</span><span class="o">=</span><span class="si">$(</span>gcloud info <span class="nt">--format</span><span class="o">=</span><span class="s1">'value(config.project)'</span><span class="si">)</span>
docker tag echo-app:v2 gcr.io/<span class="k">${</span><span class="nv">PROJECT_ID</span><span class="k">}</span>/echo-app:v2
docker push gcr.io/<span class="k">${</span><span class="nv">PROJECT_ID</span><span class="k">}</span>/echo-app:v2
</code></pre></div></div>

<p>In the web console, navigate to <em><strong>Container Registry &gt; Images</strong></em> to confirm the docker image tagged <code class="highlighter-rouge">v2</code> has been pushed to the cloud repositories.<br />
<img src="/images/posts/qwiklabs/qwiklabs-GSP305-step1-new-container-image-tagged-v2-in-container-registry.png" alt="Confirm your docker image tagged v2 existing in Google Container Registry" /></p>

<p>Next, you need to update the application to the Kubernetes Cluster.</p>

<h2 id="update-the-application-to-the-kubernetes-cluster-using-web-console">Update the Application to the Kubernetes Cluster Using Web Console</h2>

<p>Navigate to <em><strong>Kubernetes Engine &gt; Workloads</strong></em>, click the name <code class="highlighter-rouge">echo-web</code> to show the Deployment details. Press the <i class="fas fa-list-ul"></i> icon to expand the menu and select <strong>Rolling Update</strong>.<br />
<img src="/images/posts/qwiklabs/qwiklabs-GSP305-step2-expand-menu-in-Kubernetes-Engine-page.png" alt="Autoscale, Expose, Rolling Update, Scale - menu items on Deployment details page" /></p>

<p>In the Rolling Update dialog, modify the end of the image field from <code class="highlighter-rouge">v1</code> to <code class="highlighter-rouge">v2</code>.</p>

<p><img src="/images/posts/qwiklabs/qwiklabs-GSP305-step3-rolling-update-GKE-application.png" alt="Rolling update dialog" /></p>

<p>Click <strong>UPDATE</strong>.</p>

<h2 id="scale-out-the-application-so-that-the-kubernetes-cluster-deployment">Scale out the application so that the Kubernetes cluster deployment</h2>

<p>In this article, I will show you the method of using the GCP web console. If you prefer to use command-line tools, you can refer to the lab <strong>GSP053</strong> <em>â€œ<a href="https://google.qwiklabs.com/focuses/639?parent=catalog">Managing Deployments Using Kubernetes Engine</a>â€œ</em> in Qwiklabs.</p>

<p>Navigate to <em><strong>Kubernetes Engine &gt; Workloads</strong></em>, click the name <code class="highlighter-rouge">echo-web</code> to show the Deployment details. Press the <i class="fas fa-list-ul"></i> icon to expand the menu and select <strong>Scale</strong>.<br /></p>

<p><img src="/images/posts/qwiklabs/qwiklabs-GSP305-step4-select-scale-from-expanded-menu-in-Kubernetes-Engine-page.png" alt="Select Scale from menu items on Deployment details page" /></p>

<p>In the Scale dialog, type 2 to the field <strong>Replicas</strong>,</p>

<p><img src="/images/posts/qwiklabs/qwiklabs-GSP305-step5-scale-to-2-replicas.png" alt="Scale a workload to a new size" /></p>

<p>Click <strong>SCALE</strong>, then waits for creating/deleting instances until 2 replicas exist in the Kubernetes cluster.</p>

<p>Open the IP address of the external endpoint, you should see a similiar web response:<br />
<img src="/images/posts/qwiklabs/qwiklabs-GSP305-step6-updated-echo-app-application.png" alt="Resulted web page" /></p>

<p>Congratulations! You should accomplish the lab if you follow the above steps.</p>

<p>This post has also been published to Medium. If you like to read and take notes in Medium, please visit <a href="https://medium.com/@chriskyfung/qwiklab-logbook-scale-out-and-update-a-containerized-application-on-a-kubernetes-cluster-e08aa89e6aee">Medium (@chriskyfung)</a>.</p>

<hr />

<p>Do you feel this lab difficult for you? <a href="/blog/qwiklabs/Migrate-a-MySQL-Database-to-Google-Cloud-SQL">Next lab</a> will be even more challenging, but do not stop here. That is the final lab of the quest. You can earn a badge very soon!</p>

<p><strong>Related:</strong> <a href="/blog/qwiklabs/Qwiklabs-User-Tips-for-Learning_Google_Cloud_Platform">Learning Google Cloud Platform on Qwiklabs: Learning Map, Assistive Tool and Tips</a></p>
:ET